# Project Automation Workflow Template
#
# Copy this to your repo as .github/workflows/project-automation.yml
# and customize the scope detection patterns for your domain.
#
# Features:
# - Auto-triage: Labels new issues based on content
# - Auto-assign: Assigns PR author as assignee
# - Project sync: Adds issues/PRs to org project board
# - Label sync: Syncs labels when labels.yml changes
# - Stale management: Marks and closes inactive issues
# - Renovate auto-merge: Auto-merges Renovate PRs
# - Release automation: Creates releases from tags

name: Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, closed]
  push:
    branches: [main]
    paths:
      - '.github/labels.yml'
    tags:
      - 'v*'
  schedule:
    - cron: '0 9 * * 1'  # Weekly stale check, Monday 9am UTC

env:
  PROJECT_NUMBER: 3  # lvlup-sw org project

jobs:
  # ============================================================
  # LABEL SYNC: Sync labels from labels.yml on push
  # ============================================================
  label-sync:
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    uses: lvlup-sw/.github/.github/workflows/label-sync.yml@main
    secrets: inherit

  # ============================================================
  # AUTO-TRIAGE: Label new issues based on content
  # ============================================================
  auto-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Auto-label based on title/body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const text = `${issue.title} ${issue.body}`.toLowerCase();
            const labels = ['status:triage'];

            // Type detection
            if (text.match(/bug|error|fail|broken|crash|issue/)) {
              labels.push('type:bug');
            } else if (text.match(/feature|add|implement|support|enhance/)) {
              labels.push('type:feature');
            } else if (text.match(/doc|readme|typo|clarif/)) {
              labels.push('type:docs');
            } else if (text.match(/\?|how|what|why|question/)) {
              labels.push('type:question');
            }

            // TODO: Add domain-specific scope detection patterns
            // Example:
            // if (text.match(/pattern1|pattern2/)) labels.push('scope:example');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

  # ============================================================
  # AUTO-ASSIGN: Assign PR author as assignee
  # ============================================================
  auto-assign-author:
    if: github.event_name == 'pull_request' && github.event.action == 'opened' && github.event.pull_request.user.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Assign PR author
        run: gh pr edit "$PR_URL" --add-assignee "$AUTHOR"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # PROJECT SYNC: Add issues/PRs to project board
  # ============================================================
  project-sync:
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    runs-on: ubuntu-latest
    steps:
      - name: Add to project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/lvlup-sw/projects/${{ env.PROJECT_NUMBER }}
          github-token: ${{ secrets.PROJECT_TOKEN }}

  # ============================================================
  # STALE MANAGEMENT: Mark and close inactive issues
  # ============================================================
  stale:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/stale@v9
        with:
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed in 14 days if no further activity occurs.
          close-issue-message: |
            This issue was closed because it has been stale for 14 days with no activity.
            Feel free to reopen if this is still relevant.
          stale-issue-label: 'status:stale'
          exempt-issue-labels: 'priority:high,status:blocked'
          days-before-stale: 60
          days-before-close: 14
          operations-per-run: 30

  # ============================================================
  # PR AUTOMATION: Auto-merge Renovate PRs
  # ============================================================
  auto-merge-renovate:
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for Renovate PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # RELEASE AUTOMATION: Generate changelog and release
  # ============================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: .github/cliff.toml
          args: --latest --strip header

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.content }}
          generate_release_notes: false
