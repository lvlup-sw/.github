# =============================================================================
# Reusable Workflow: Build & Test with Coverage
# =============================================================================
# Builds a .NET solution, runs test projects with coverage collection, merges
# coverage reports, and uploads the result as an artifact.
#
# Usage:
#   jobs:
#     test:
#       uses: lvlup-sw/.github/.github/workflows/build-and-test.yml@main
#       with:
#         solution-path: 'MyProject.slnx'
#         test-project-patterns: |
#           **/tests/**/*.Tests.csproj
#           **/src/**/*.Tests.csproj
#
# Coverage:
#   - Each test project produces a Cobertura XML report
#   - Reports are merged via ReportGenerator into coverage.cobertura.xml
#   - Uploaded as the 'coverage-reports' artifact (7-day retention)
#
# Skip patterns:
#   - Use skip-patterns to exclude test projects (e.g., integration tests)
#   - Patterns are matched against the full project path using bash globbing
# =============================================================================

name: Build & Test

on:
  workflow_call:
    inputs:
      solution-path:
        description: 'Path to solution file (.sln or .slnx)'
        required: true
        type: string
      test-project-patterns:
        description: 'Newline-separated glob patterns for test .csproj files'
        required: true
        type: string
      skip-patterns:
        description: 'Newline-separated glob patterns to skip (e.g., *Integration.Tests*)'
        required: false
        type: string
        default: ''
      coverage-filters:
        description: 'ReportGenerator -assemblyfilters value'
        required: false
        type: string
        default: ''
      runner:
        description: 'GitHub Actions runner label'
        required: false
        type: string
        default: 'ubuntu-latest'
      dotnet-version:
        description: '.NET SDK version (e.g., 9.0.x, 10.0.x)'
        required: false
        type: string
        default: '10.0.x'
      dotnet-quality:
        description: '.NET SDK quality (ga, preview)'
        required: false
        type: string
        default: 'preview'
    outputs:
      tests-passed:
        description: 'Whether all test projects passed'
        value: ${{ jobs.test.outputs.tests-passed }}

jobs:
  test:
    name: Build & Test
    runs-on: ${{ inputs.runner }}
    outputs:
      tests-passed: ${{ steps.run-tests.outputs.tests-passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          dotnet-quality: ${{ inputs.dotnet-quality }}

      - name: Restore dependencies
        run: dotnet restore ${{ inputs.solution-path }}

      - name: Build
        run: dotnet build ${{ inputs.solution-path }} --no-restore --configuration Release

      - name: Run tests with coverage
        id: run-tests
        run: |
          mkdir -p ./TestResults
          failed=0

          while IFS= read -r pattern; do
            [[ -z "$pattern" ]] && continue
            for proj in $pattern; do
              # Skip if glob didn't expand (no matching files)
              [[ ! -f "$proj" ]] && continue

              # Check skip patterns
              skip=false
              while IFS= read -r skip_pat; do
                [[ -z "$skip_pat" ]] && continue
                if [[ "$proj" == $skip_pat ]]; then
                  skip=true
                  break
                fi
              done <<< "${{ inputs.skip-patterns }}"

              if [[ "$skip" == "true" ]]; then
                echo "Skipping: $proj"
                continue
              fi

              projname=$(basename "$proj" .csproj)
              coverage_path="${GITHUB_WORKSPACE}/TestResults/${projname}.cobertura.xml"
              echo "Running tests: $proj"

              if ! dotnet run --project "$proj" --configuration Release -- \
                --coverage \
                --coverage-output-format cobertura \
                --coverage-output "$coverage_path"; then
                echo "::error::Tests failed for $proj"
                failed=1
              fi
            done
          done <<< "${{ inputs.test-project-patterns }}"

          if [[ "$failed" -eq 0 ]]; then
            echo "tests-passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests-passed=false" >> $GITHUB_OUTPUT
          fi

          exit $failed

      - name: Merge coverage reports
        if: always()
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          export PATH="$PATH:$HOME/.dotnet/tools"

          if ls ./TestResults/*.cobertura.xml 1> /dev/null 2>&1; then
            FILTER_ARG=""
            if [[ -n "${{ inputs.coverage-filters }}" ]]; then
              FILTER_ARG="-assemblyfilters:${{ inputs.coverage-filters }}"
            fi

            reportgenerator \
              -reports:"./TestResults/*.cobertura.xml" \
              -targetdir:"./TestResults" \
              -reporttypes:"Cobertura" \
              $FILTER_ARG \
              -verbosity:Warning

            if [ -f "./TestResults/Cobertura.xml" ]; then
              cp ./TestResults/Cobertura.xml ./TestResults/coverage.cobertura.xml
            fi
          else
            echo "::warning::No coverage files found in ./TestResults/"
          fi

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: ./TestResults/coverage.cobertura.xml
          retention-days: 7
          if-no-files-found: warn
