# Iteration Manager - Automatically manages project iterations
#
# Runs weekly to:
# - Check if new iterations are needed
# - Create new iterations when current coverage is running low
# - Report current iteration status
#
# Also runs on workflow_dispatch for manual execution

name: Iteration Manager

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check-and-create'
        type: choice
        options:
          - check-and-create
          - create-next-iteration
          - rollover-incomplete

env:
  PROJECT_NUMBER: 3
  ORG: lvlup-sw
  ITERATION_DURATION_DAYS: 14
  ITERATIONS_AHEAD: 2  # Always have 2 iterations ahead

jobs:
  manage-iterations:
    runs-on: ubuntu-latest
    steps:
      - name: Get project and iteration field
        id: project
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Get project ID and iteration field
          RESULT=$(gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2IterationField {
                        id
                        name
                        configuration {
                          duration
                          iterations {
                            id
                            title
                            startDate
                            duration
                          }
                          completedIterations {
                            id
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f org="$ORG" -F number=$PROJECT_NUMBER)

          PROJECT_ID=$(echo "$RESULT" | jq -r '.data.organization.projectV2.id')
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

          # Find iteration field
          ITERATION_FIELD=$(echo "$RESULT" | jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Sprint" or .name == "Iteration") | .id' | head -1)
          echo "iteration_field_id=$ITERATION_FIELD" >> $GITHUB_OUTPUT

          # Get current iterations (compact JSON to avoid multi-line $GITHUB_OUTPUT issues)
          ITERATIONS=$(echo "$RESULT" | jq -c '.data.organization.projectV2.fields.nodes[] | select(.name == "Sprint" or .name == "Iteration") | .configuration.iterations')
          echo "iterations=$ITERATIONS" >> $GITHUB_OUTPUT

          echo "Project ID: $PROJECT_ID"
          echo "Iteration Field: $ITERATION_FIELD"
          echo "Iterations: $(echo "$ITERATIONS" | jq .)"

      - name: Check if new iteration needed
        id: check
        run: |
          ITERATIONS='${{ steps.project.outputs.iterations }}'

          if [ -z "$ITERATIONS" ] || [ "$ITERATIONS" == "null" ]; then
            echo "No iterations found - need to create some"
            echo "needs_creation=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find the latest iteration end date
          TODAY=$(date +%Y-%m-%d)
          LATEST_END=$(echo "$ITERATIONS" | jq -r '
            [.[] | {
              start: .startDate,
              days: (.duration * 7)
            }] | sort_by(.start) | last |
            .start as $s | .days as $d |
            ($s + " + " + ($d | tostring) + " days")
          ')
          # Use date -d for reliable date arithmetic
          LATEST_END=$(date -d "$LATEST_END" +%Y-%m-%d)

          echo "Today: $TODAY"
          echo "Latest iteration ends: $LATEST_END"

          # Calculate days until latest iteration ends
          TODAY_TS=$(date -d "$TODAY" +%s)
          LATEST_END_TS=$(date -d "$LATEST_END" +%s)
          DAYS_AHEAD=$(( (LATEST_END_TS - TODAY_TS) / 86400 ))

          echo "Days of iterations ahead: $DAYS_AHEAD"

          # If less than ITERATIONS_AHEAD * ITERATION_DURATION_DAYS ahead, create more
          THRESHOLD=$(( ${{ env.ITERATIONS_AHEAD }} * ${{ env.ITERATION_DURATION_DAYS }} ))
          if [ "$DAYS_AHEAD" -lt "$THRESHOLD" ]; then
            echo "Need to create more iterations (only $DAYS_AHEAD days ahead, threshold: $THRESHOLD)"
            echo "needs_creation=true" >> $GITHUB_OUTPUT
          else
            echo "Sufficient iterations exist ($DAYS_AHEAD days ahead)"
            echo "needs_creation=false" >> $GITHUB_OUTPUT
          fi

      - name: Create new iteration
        if: steps.check.outputs.needs_creation == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "::notice::Creating new iteration..."

          ITERATIONS='${{ steps.project.outputs.iterations }}'
          FIELD_ID="${{ steps.project.outputs.iteration_field_id }}"

          # Calculate start date for new iteration
          if [ -z "$ITERATIONS" ] || [ "$ITERATIONS" == "null" ] || [ "$ITERATIONS" == "[]" ]; then
            # No iterations exist - start from next Monday
            START_DATE=$(date -d "next monday" +%Y-%m-%d)
            ITERATION_NUM=1
          else
            # Get the latest iteration details
            LATEST_START=$(echo "$ITERATIONS" | jq -r 'sort_by(.startDate) | last | .startDate')
            LATEST_DURATION=$(echo "$ITERATIONS" | jq -r 'sort_by(.startDate) | last | .duration')
            LATEST_TITLE=$(echo "$ITERATIONS" | jq -r 'sort_by(.startDate) | last | .title')

            # Calculate end date of latest iteration = start of new one
            START_DATE=$(date -d "$LATEST_START + $((LATEST_DURATION * 7)) days" +%Y-%m-%d)

            # Extract iteration number from title (e.g., "Sprint 5" -> 5, "Iteration 3" -> 3)
            ITERATION_NUM=$(echo "$LATEST_TITLE" | grep -oE '[0-9]+' | tail -1)
            ITERATION_NUM=$((ITERATION_NUM + 1))
          fi

          TITLE="Sprint $ITERATION_NUM"
          DURATION_WEEKS=$(( ${{ env.ITERATION_DURATION_DAYS }} / 7 ))
          echo "Creating iteration: $TITLE starting $START_DATE (${DURATION_WEEKS}w)"

          # Fetch existing iterations to preserve them when appending
          EXISTING=$(echo "$ITERATIONS" | jq -c '[.[] | {startDate: .startDate, duration: .duration}]')
          # Append new iteration
          UPDATED=$(echo "$EXISTING" | jq -c --arg start "$START_DATE" --argjson dur "$DURATION_WEEKS" \
            '. + [{startDate: $start, duration: $dur}]')

          gh api graphql -f query='
            mutation($fieldId: ID!, $iterations: [ProjectV2IterationFieldIteration!]!) {
              updateProjectV2Field(input: {
                fieldId: $fieldId
                iterationField: {
                  iterations: $iterations
                }
              }) {
                projectV2Field {
                  ... on ProjectV2IterationField {
                    id
                    configuration {
                      iterations { id title startDate duration }
                    }
                  }
                }
              }
            }' \
            -f fieldId="$FIELD_ID" \
            --argjson iterations "$UPDATED" && \
            echo "::notice::Created iteration $TITLE starting $START_DATE" || \
            echo "::warning::Could not create iteration via API - create manually: $TITLE starting $START_DATE (${DURATION_WEEKS}-week sprint)"

      - name: Get current iteration
        id: current
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ITERATIONS='${{ steps.project.outputs.iterations }}'
          TODAY=$(date +%Y-%m-%d)

          if [ -z "$ITERATIONS" ] || [ "$ITERATIONS" == "null" ]; then
            echo "current_iteration_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find iteration containing today using date -d for end date calculation
          CURRENT=""
          for row in $(echo "$ITERATIONS" | jq -c '.[]'); do
            START=$(echo "$row" | jq -r '.startDate')
            DURATION=$(echo "$row" | jq -r '.duration')
            ID=$(echo "$row" | jq -r '.id')
            END=$(date -d "$START + $((DURATION * 7)) days" +%Y-%m-%d)
            if [[ "$TODAY" >= "$START" && "$TODAY" < "$END" ]]; then
              CURRENT="$ID"
              break
            fi
          done

          echo "current_iteration_id=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current iteration: ${CURRENT:-None}"

      - name: Summary
        run: |
          echo "## Iteration Manager Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project ID**: ${{ steps.project.outputs.project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Iteration Field**: ${{ steps.project.outputs.iteration_field_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Iteration**: ${{ steps.current.outputs.current_iteration_id || 'None' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Needed Creation**: ${{ steps.check.outputs.needs_creation }}" >> $GITHUB_STEP_SUMMARY
