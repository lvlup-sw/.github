# Reusable workflow for syncing labels from labels.yml to GitHub
#
# Usage in your repo's workflow:
#   jobs:
#     sync-labels:
#       uses: lvlup-sw/.github/.github/workflows/label-sync.yml@main
#       secrets: inherit

name: Label Sync

on:
  workflow_call:
    inputs:
      labels-file:
        description: 'Path to labels YAML file'
        required: false
        default: '.github/labels.yml'
        type: string
      delete-unlisted:
        description: 'Delete labels not in the YAML file'
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            // Read and parse labels.yml
            const labelsFile = '${{ inputs.labels-file }}';
            if (!fs.existsSync(labelsFile)) {
              console.log(`Labels file not found: ${labelsFile}`);
              return;
            }

            const content = fs.readFileSync(labelsFile, 'utf8');
            const labelDefs = yaml.load(content);

            if (!Array.isArray(labelDefs)) {
              console.log('Labels file must contain an array of label definitions');
              return;
            }

            // Get existing labels
            const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const existingMap = new Map(existingLabels.map(l => [l.name, l]));
            const definedNames = new Set();

            // Create or update labels
            for (const label of labelDefs) {
              if (!label.name) continue;

              definedNames.add(label.name);
              const existing = existingMap.get(label.name);
              const color = (label.color || '').replace('#', '');
              const description = label.description || '';

              if (existing) {
                // Check if update needed
                const needsUpdate =
                  existing.color.toLowerCase() !== color.toLowerCase() ||
                  (existing.description || '') !== description;

                if (needsUpdate) {
                  console.log(`Updating: ${label.name}`);
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: color,
                    description: description
                  });
                } else {
                  console.log(`Unchanged: ${label.name}`);
                }
              } else {
                console.log(`Creating: ${label.name}`);
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: color,
                  description: description
                });
              }
            }

            // Optionally delete unlisted labels
            if (${{ inputs.delete-unlisted }}) {
              for (const existing of existingLabels) {
                if (!definedNames.has(existing.name)) {
                  console.log(`Deleting: ${existing.name}`);
                  await github.rest.issues.deleteLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: existing.name
                  });
                }
              }
            }

            console.log('Label sync complete');
