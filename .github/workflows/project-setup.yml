# One-time project setup workflow
#
# Configures Project 3 with:
# - Priority field (P0/P1/P2)
# - Iteration field with 2-week sprints
# - Syncs all open issues from specified repos
#
# Run manually via: Actions > Project Setup > Run workflow

name: Project Setup

on:
  workflow_dispatch:
    inputs:
      create_iterations:
        description: 'Number of iterations to create'
        required: true
        default: '4'
        type: string
      iteration_duration:
        description: 'Iteration duration in days'
        required: true
        default: '14'
        type: string
      sync_existing_issues:
        description: 'Sync existing open issues to project'
        required: true
        default: true
        type: boolean

env:
  PROJECT_NUMBER: 3
  ORG: lvlup-sw
  REPOS: 'ares-elite-platform,agentic-workflow,agentic-engine,lvlup-claude,DataFerry'

jobs:
  setup-project:
    runs-on: ubuntu-latest
    steps:
      - name: Get project ID
        id: project
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  title
                }
              }
            }' -f org="$ORG" -F number=$PROJECT_NUMBER --jq '.data.organization.projectV2.id')

          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Project ID: $PROJECT_ID"

      - name: Get or create Priority field
        id: priority
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Check if Priority field exists
          PRIORITY_FIELD=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  field(name: "Priority") {
                    ... on ProjectV2SingleSelectField {
                      id
                      options { id name }
                    }
                  }
                }
              }
            }' -f projectId="${{ steps.project.outputs.project_id }}" --jq '.data.node.field.id // empty')

          if [ -n "$PRIORITY_FIELD" ]; then
            echo "Priority field exists: $PRIORITY_FIELD"
            echo "field_id=$PRIORITY_FIELD" >> $GITHUB_OUTPUT
          else
            echo "Creating Priority field..."
            PRIORITY_FIELD=$(gh api graphql -f query='
              mutation($projectId: ID!) {
                createProjectV2Field(input: {
                  projectId: $projectId
                  dataType: SINGLE_SELECT
                  name: "Priority"
                  singleSelectOptions: [
                    {name: "P0", color: RED, description: "Critical - drop everything"},
                    {name: "P1", color: ORANGE, description: "High - address this sprint"},
                    {name: "P2", color: YELLOW, description: "Medium - address soon"},
                    {name: "P3", color: GREEN, description: "Low - nice to have"}
                  ]
                }) {
                  projectV2Field { ... on ProjectV2SingleSelectField { id } }
                }
              }' -f projectId="${{ steps.project.outputs.project_id }}" --jq '.data.createProjectV2Field.projectV2Field.id')
            echo "Created Priority field: $PRIORITY_FIELD"
            echo "field_id=$PRIORITY_FIELD" >> $GITHUB_OUTPUT
          fi

      - name: Get or create Iteration field
        id: iteration
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Check if Iteration/Sprint field exists
          ITERATION_FIELD=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2IterationField {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }' -f projectId="${{ steps.project.outputs.project_id }}" --jq '.data.node.fields.nodes[] | select(.name == "Sprint" or .name == "Iteration") | .id' | head -1)

          if [ -n "$ITERATION_FIELD" ]; then
            echo "Iteration field exists: $ITERATION_FIELD"
            echo "field_id=$ITERATION_FIELD" >> $GITHUB_OUTPUT
          else
            echo "Creating Iteration field..."
            # Note: createProjectV2IterationField is not available via API
            # Iterations must be created via UI first, then managed via API
            echo "::warning::Iteration field must be created manually in GitHub UI first"
            echo "field_id=" >> $GITHUB_OUTPUT
          fi

      - name: Sync existing issues to project
        if: ${{ inputs.sync_existing_issues }}
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Syncing existing issues from repos: $REPOS"

          IFS=',' read -ra REPO_ARRAY <<< "$REPOS"
          for repo in "${REPO_ARRAY[@]}"; do
            echo "Processing $repo..."

            # Get all open issues (id is the GraphQL node ID)
            ISSUES=$(gh issue list --repo "$ORG/$repo" --state open --json number,id --limit 100)

            # Add each issue to project
            echo "$ISSUES" | jq -r '.[].id' | while read -r node_id; do
              if [ -n "$node_id" ]; then
                echo "Adding issue $node_id to project..."
                gh api graphql -f query='
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item { id }
                    }
                  }' -f projectId="${{ steps.project.outputs.project_id }}" -f contentId="$node_id" 2>/dev/null || echo "  (already in project or error)"
              fi
            done

            echo "Completed $repo"
          done

      - name: Set priorities based on labels
        if: ${{ inputs.sync_existing_issues }}
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Setting priorities based on issue labels..."

          PROJECT_ID="${{ steps.project.outputs.project_id }}"

          # Get Priority field options
          PRIORITY_DATA=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  field(name: "Priority") {
                    ... on ProjectV2SingleSelectField {
                      id
                      options { id name }
                    }
                  }
                }
              }
            }' -f projectId="$PROJECT_ID")

          PRIORITY_FIELD_ID=$(echo "$PRIORITY_DATA" | jq -r '.data.node.field.id')

          # Get available options (field may not have all P0-P3)
          echo "Available priority options:"
          echo "$PRIORITY_DATA" | jq -r '.data.node.field.options[] | "\(.name): \(.id)"'

          P0_ID=$(echo "$PRIORITY_DATA" | jq -r '.data.node.field.options[] | select(.name == "P0") | .id // empty')
          P1_ID=$(echo "$PRIORITY_DATA" | jq -r '.data.node.field.options[] | select(.name == "P1") | .id // empty')
          P2_ID=$(echo "$PRIORITY_DATA" | jq -r '.data.node.field.options[] | select(.name == "P2") | .id // empty')
          P3_ID=$(echo "$PRIORITY_DATA" | jq -r '.data.node.field.options[] | select(.name == "P3") | .id // empty')

          echo "Priority field: $PRIORITY_FIELD_ID"
          echo "P0=$P0_ID, P1=$P1_ID, P2=$P2_ID, P3=$P3_ID"

          # If P3 doesn't exist, create it
          if [ -z "$P3_ID" ]; then
            echo "P3 option not found, creating it..."
            P3_RESULT=$(gh api graphql -f query='
              mutation($fieldId: ID!) {
                updateProjectV2Field(input: {
                  fieldId: $fieldId
                  singleSelectOptions: [
                    {name: "P0", color: RED, description: "Critical - drop everything"},
                    {name: "P1", color: ORANGE, description: "High - address this sprint"},
                    {name: "P2", color: YELLOW, description: "Medium - address soon"},
                    {name: "P3", color: GREEN, description: "Low - nice to have"}
                  ]
                }) {
                  projectV2Field {
                    ... on ProjectV2SingleSelectField {
                      options { id name }
                    }
                  }
                }
              }' -f fieldId="$PRIORITY_FIELD_ID" 2>&1) || true

            # Try to get P3 ID again
            P3_ID=$(echo "$P3_RESULT" | jq -r '.data.updateProjectV2Field.projectV2Field.options[] | select(.name == "P3") | .id // empty' 2>/dev/null)
            if [ -z "$P3_ID" ]; then
              echo "Could not create P3, using P2 as fallback"
              P3_ID="$P2_ID"
            else
              echo "Created P3: $P3_ID"
            fi
          fi

          # Get Iteration field and current iteration
          ITER_DATA=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2IterationField {
                        id
                        name
                        configuration {
                          iterations { id title startDate duration }
                        }
                      }
                    }
                  }
                }
              }
            }' -f projectId="$PROJECT_ID")

          ITER_FIELD_ID=$(echo "$ITER_DATA" | jq -r '.data.node.fields.nodes[] | select(.name == "Sprint" or .name == "Iteration") | .id' | head -1)

          # Find current iteration (if any)
          NOW=$(date +%s)
          CURRENT_ITER_ID=""
          if [ -n "$ITER_FIELD_ID" ]; then
            CURRENT_ITER_ID=$(echo "$ITER_DATA" | jq -r --argjson now "$NOW" '
              .data.node.fields.nodes[]
              | select(.name == "Sprint" or .name == "Iteration")
              | .configuration.iterations[]
              | select(
                  ($now >= ((.startDate | strptime("%Y-%m-%d") | mktime))) and
                  ($now < ((.startDate | strptime("%Y-%m-%d") | mktime) + (.duration * 7 * 86400)))
                )
              | .id' 2>/dev/null | head -1)
          fi
          echo "Iteration field: $ITER_FIELD_ID, Current iteration: $CURRENT_ITER_ID"

          # Get all project items
          ITEMS=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          title
                          body
                          labels(first: 10) {
                            nodes { name }
                          }
                        }
                        ... on PullRequest {
                          id
                          title
                          body
                          labels(first: 10) {
                            nodes { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -f projectId="$PROJECT_ID")

          # Process each item
          echo "$ITEMS" | jq -c '.data.node.items.nodes[]' | while read -r item; do
            ITEM_ID=$(echo "$item" | jq -r '.id')
            LABELS=$(echo "$item" | jq -r '[.content.labels.nodes[].name] | join(",")')
            BODY=$(echo "$item" | jq -r '.content.body // ""' | tr '[:upper:]' '[:lower:]')
            TITLE=$(echo "$item" | jq -r '.content.title // ""')

            echo "Processing: $TITLE (labels: $LABELS)"

            # Determine priority
            PRIORITY_ID="$P2_ID"  # Default
            IS_HIGH=false

            if echo "$LABELS" | grep -q "priority:high"; then
              IS_HIGH=true
              # Check for urgent keywords
              if echo "$BODY" | grep -qE "urgent|critical|blocker|p0|asap|emergency"; then
                PRIORITY_ID="$P0_ID"
                echo "  -> P0 (high + urgent)"
              else
                PRIORITY_ID="$P1_ID"
                echo "  -> P1 (high)"
              fi
            elif echo "$LABELS" | grep -q "priority:low"; then
              PRIORITY_ID="$P3_ID"
              echo "  -> P3 (low)"
            else
              echo "  -> P2 (default)"
            fi

            # Set priority
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $value }
                }) { projectV2Item { id } }
              }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$PRIORITY_FIELD_ID" -f value="$PRIORITY_ID" >/dev/null

            # Set iteration for high priority items
            if [ "$IS_HIGH" = true ] && [ -n "$CURRENT_ITER_ID" ] && [ -n "$ITER_FIELD_ID" ]; then
              echo "  -> Assigning to current iteration"
              gh api graphql -f query='
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { iterationId: $value }
                  }) { projectV2Item { id } }
                }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$ITER_FIELD_ID" -f value="$CURRENT_ITER_ID" >/dev/null
            fi
          done

          echo "Priority assignment complete!"

      - name: Summary
        run: |
          echo "## Project Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project ID**: ${{ steps.project.outputs.project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Priority Field**: ${{ steps.priority.outputs.field_id || 'Created' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Iteration Field**: ${{ steps.iteration.outputs.field_id || 'Needs manual creation' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Priority Mapping" >> $GITHUB_STEP_SUMMARY
          echo "| Label | Priority |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| priority:high + urgent keywords | P0 |" >> $GITHUB_STEP_SUMMARY
          echo "| priority:high | P1 |" >> $GITHUB_STEP_SUMMARY
          echo "| (no priority label) | P2 |" >> $GITHUB_STEP_SUMMARY
          echo "| priority:low | P3 |" >> $GITHUB_STEP_SUMMARY
