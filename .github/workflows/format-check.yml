# =============================================================================
# Reusable Workflow: Code Format Verification & Auto-Fix
# =============================================================================
# Verifies code formatting using 'dotnet format'. If issues are found on a PR,
# automatically fixes them and commits the changes back to the branch.
#
# Uses 'dotnet format whitespace' + 'dotnet format style' separately to avoid
# analyzer code fixer crashes on .NET 10 preview (System.NotSupportedException:
# Changing document properties is not supported). Analyzer issues are caught by
# the build step instead.
#
# Usage:
#   jobs:
#     format:
#       uses: lvlup-sw/.github/.github/workflows/format-check.yml@main
#       with:
#         solution-path: 'MyProject.slnx'
#         dotnet-version: '10.0.x'
#         dotnet-quality: 'preview'
#
# Auto-fix behavior:
#   - On pull_request: Fixes issues and commits to PR branch
#   - On push to main/develop: Fails (no auto-fix on protected branches)
#   - Set auto-fix: false to disable auto-fix entirely
# =============================================================================

name: Format Check

on:
  workflow_call:
    inputs:
      solution-path:
        description: 'Path to solution file (.sln or .slnx)'
        required: true
        type: string
      dotnet-version:
        description: '.NET SDK version (e.g., 9.0.x, 10.0.x)'
        required: false
        type: string
        default: '9.0.x'
      dotnet-quality:
        description: '.NET SDK quality (ga, preview)'
        required: false
        type: string
        default: 'ga'
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      auto-fix:
        description: 'Automatically fix and commit formatting issues on PRs'
        required: false
        type: boolean
        default: true

jobs:
  format:
    name: Verify Formatting
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use the PR head ref for PRs, otherwise use the default
          ref: ${{ github.head_ref || github.ref }}
          # Need to fetch with token that can push
          token: ${{ github.token }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          dotnet-quality: ${{ inputs.dotnet-quality }}

      - name: Restore dependencies
        run: dotnet restore ${{ inputs.solution-path }}

      - name: Check formatting
        id: format-check
        run: |
          echo "Checking code formatting..."
          failed=false

          # Check whitespace formatting (indentation, spacing, line endings)
          if ! dotnet format whitespace ${{ inputs.solution-path }} --verify-no-changes --verbosity normal 2>&1; then
            echo "⚠️ Whitespace formatting issues detected."
            failed=true
          fi

          # Check style formatting (using directives, code style rules)
          if ! dotnet format style ${{ inputs.solution-path }} --verify-no-changes --verbosity normal 2>&1; then
            echo "⚠️ Style formatting issues detected."
            failed=true
          fi

          # Note: 'dotnet format analyzers' is intentionally skipped here.
          # Analyzer code fixers crash on .NET 10 preview with:
          #   System.NotSupportedException: Changing document properties is not supported
          # Analyzer rules are enforced during build via Lvlup.Build globalconfig instead.

          if [ "$failed" = true ]; then
            echo "formatted=true" >> $GITHUB_OUTPUT
          else
            echo "formatted=false" >> $GITHUB_OUTPUT
            echo "✅ Code formatting verified - no issues found."
          fi

      - name: Auto-fix formatting
        if: steps.format-check.outputs.formatted == 'true' && inputs.auto-fix && github.event_name == 'pull_request'
        run: |
          echo "Running dotnet format to fix issues..."
          dotnet format whitespace ${{ inputs.solution-path }} --verbosity normal
          dotnet format style ${{ inputs.solution-path }} --verbosity normal
          echo "✅ Formatting fixed."

      - name: Commit fixes
        if: steps.format-check.outputs.formatted == 'true' && inputs.auto-fix && github.event_name == 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "No changes to commit after formatting."
            exit 0
          fi

          git add -A
          git commit -m "style: auto-fix formatting via dotnet format

          Applied automatic formatting fixes using 'dotnet format'.

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push
          echo "✅ Formatting fixes committed and pushed."

      - name: Fail if issues found and not auto-fixed
        if: steps.format-check.outputs.formatted == 'true' && (!inputs.auto-fix || github.event_name != 'pull_request')
        run: |
          echo ""
          echo "=========================================="
          echo "❌ Code formatting issues detected!"
          echo "=========================================="
          echo ""
          echo "To fix locally, run:"
          echo ""
          echo "  dotnet format whitespace ${{ inputs.solution-path }}"
          echo "  dotnet format style ${{ inputs.solution-path }}"
          echo ""
          echo "Then commit the changes and push."
          echo ""
          exit 1
