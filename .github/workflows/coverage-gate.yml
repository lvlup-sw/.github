# =============================================================================
# Reusable Workflow: Coverage Gate & PR Comment
# =============================================================================
# Enforces code coverage thresholds and posts a summary comment on pull
# requests. Designed to run AFTER build-and-test.yml has uploaded the
# 'coverage-reports' artifact containing Cobertura XML files.
#
# Usage:
#   jobs:
#     coverage:
#       uses: lvlup-sw/.github/.github/workflows/coverage-gate.yml@main
#       with:
#         coverage-threshold: 90
#
# Behavior:
#   - Downloads coverage artifacts from the calling workflow
#   - Merges reports using ReportGenerator
#   - Runs coverage-gate.sh to enforce the threshold
#   - Posts or updates a PR comment with the coverage summary
# =============================================================================

name: Coverage Gate

on:
  workflow_call:
    inputs:
      coverage-threshold:
        description: 'Minimum line coverage percent'
        required: false
        type: number
        default: 90
      dotnet-version:
        description: '.NET SDK version for ReportGenerator (e.g., 9.0.x, 10.0.x)'
        required: false
        type: string
        default: '9.0.x'
      runner:
        description: 'GitHub Actions runner label'
        required: false
        type: string
        default: 'blacksmith-4vcpu-ubuntu-2204'

jobs:
  coverage-gate:
    name: Enforce Coverage Threshold
    runs-on: ${{ inputs.runner }}
    permissions:
      pull-requests: write
    steps:
      - name: Checkout shared scripts
        uses: actions/checkout@v4
        with:
          repository: lvlup-sw/.github
          sparse-checkout: scripts/ci
          path: .shared

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: ./coverage-reports

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Merge coverage reports
        run: |
          reportgenerator \
            -reports:"./coverage-reports/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-merged" \
            -reporttypes:"Cobertura;TextSummary"

      - name: Run coverage gate
        id: coverage
        run: |
          chmod +x .shared/scripts/ci/coverage-gate.sh
          .shared/scripts/ci/coverage-gate.sh \
            --coverage-file ./coverage-merged/Cobertura.xml \
            --threshold ${{ inputs.coverage-threshold }} \
            --output-dir ./coverage-merged

      - name: Post PR comment
        if: always() && github.event.pull_request.number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f "./coverage-merged/pr-comment.md" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --body-file ./coverage-merged/pr-comment.md \
              --edit-last || \
            gh pr comment ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --body-file ./coverage-merged/pr-comment.md
          fi
